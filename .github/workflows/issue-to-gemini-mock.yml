name: Issue to Gemini Calculator (Mock for Default Runner)

on:
  issues:
    types: [opened]

jobs:
  calculate-mock:
    # ê¸°ë³¸ GitHub í˜¸ìŠ¤íŒ… ëŸ¬ë„ˆì—ì„œ ì‹¤í–‰ (tmux ì—†ì´)
    runs-on: ubuntu-latest
    # self-hosted ëŸ¬ë„ˆê°€ ì—†ì„ ë•Œë§Œ ì‹¤í–‰
    if: ${{ !contains(github.event.issue.labels.*.name, 'skip-auto') && !contains(github.event.issue.labels.*.name, 'use-real-gemini') }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Parse Issue to EXEC
        id: parse
        run: |
          # ì´ìŠˆ ì œëª©ê³¼ ë²ˆí˜¸ ì¶”ì¶œ
          ISSUE_NUM="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          
          # EXEC ë©”ì‹œì§€ ìƒì„± (ê³„ì‚° ìš”ì²­ì¸ ê²½ìš°)
          if echo "$ISSUE_TITLE" | grep -E "[0-9+\-*/]"; then
            # ì œëª©ì—ì„œ ìˆ˜ì‹ ì¶”ì¶œ (ì˜ˆ: "1+1ì€ ë¬´ì—‡ì…ë‹ˆê¹Œ" â†’ "1+1")
            EXPR=$(echo "$ISSUE_TITLE" | sed 's/[^0-9+\-*/()]//g')
            EXEC_MSG="CALC expr=\"$EXPR\" target=mock task_id=ISSUE-$ISSUE_NUM"
            echo "exec_msg=$EXEC_MSG" >> $GITHUB_OUTPUT
            echo "task_id=ISSUE-$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "expression=$EXPR" >> $GITHUB_OUTPUT
            echo "should_process=true" >> $GITHUB_OUTPUT
          else
            echo "should_process=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Install Dependencies
        if: steps.parse.outputs.should_process == 'true'
        run: |
          pip install -r requirements.txt
      
      - name: Execute via OrchestrEX (Mock Mode)
        if: steps.parse.outputs.should_process == 'true'
        id: execute
        env:
          MOCK_GEMINI: "true"
        run: |
          # Mock ëª¨ë“œë¡œ ì‹¤í–‰ (ì‹¤ì œ Gemini ì—†ì´ ê³„ì‚°)
          python scripts/exec_to_gemini.py \
            --exec "${{ steps.parse.outputs.exec_msg }}" \
            --output /tmp/result.txt \
            --mock 2>&1 | tee /tmp/execution.log
          
          # ê²°ê³¼ í™•ì¸
          if [ -f /tmp/result.txt ]; then
            echo "result=$(cat /tmp/result.txt)" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload debug artifacts
        if: always() && steps.parse.outputs.should_process == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: gemini-mock-execution-logs
          path: |
            /tmp/execution.log
            /tmp/result.txt
          retention-days: 7
      
      - name: Comment Result
        if: steps.parse.outputs.should_process == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const expression = '${{ steps.parse.outputs.expression }}';
            const exec_msg = '${{ steps.parse.outputs.exec_msg }}';
            const task_id = '${{ steps.parse.outputs.task_id }}';
            const success = '${{ steps.execute.outputs.success }}' === 'true';
            const result = '${{ steps.execute.outputs.result }}';
            
            let comment_body;
            if (success) {
              comment_body = `## ğŸ¤– ê³„ì‚° ê²°ê³¼ (Mock Mode)
              
**ë¬¸ì œ**: ${expression}
**ë‹µ**: **${result}**

---
*EXEC: \`${exec_msg}\`*
*Task ID: ${task_id}*
*âš ï¸ Mock ëª¨ë“œë¡œ ì‹¤í–‰ë¨ (ì‹¤ì œ Gemini ì—†ì´ ê³„ì‚°)*
*ì‹¤ì œ Geminië¥¼ ì‚¬ìš©í•˜ë ¤ë©´ self-hosted ëŸ¬ë„ˆê°€ í•„ìš”í•©ë‹ˆë‹¤.*`;
            } else {
              comment_body = `âš ï¸ ê³„ì‚° ì‹¤íŒ¨
              
ë””ë²„ê·¸ ì •ë³´ëŠ” [Actions ì•„í‹°íŒ©íŠ¸](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: comment_body
            });